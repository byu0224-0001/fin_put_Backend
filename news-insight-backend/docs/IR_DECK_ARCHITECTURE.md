# 동적 밸류체인 KG 아키텍처 (IR DECK)

## 📊 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         데이터 수집 (Data Collection)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐        │
│  │  기업 DATA        │  │  증권사 리포트   │  │  기업 및 산업    │        │
│  │                  │  │                  │  │  DATA            │        │
│  │  ┌────────────┐  │  │  ┌────────────┐ │  │  ┌────────────┐  │        │
│  │  │ DART       │  │  │  │ NAVER       │ │  │  │ 위키백과   │  │        │
│  │  │ 전자공시   │  │  │  │ 한국경제    │ │  │  │ Wikipedia  │  │        │
│  │  │ 시스템     │  │  │  │             │ │  │  │            │  │        │
│  │  └────────────┘  │  │  └────────────┘ │  │  └────────────┘  │        │
│  │                  │  │                  │  │                  │        │
│  │  • 사업보고서    │  │  • 산업 리포트   │  │  • 산업 정보     │        │
│  │  • 공시 데이터   │  │  • 기업 분석     │  │  • 기업 개요     │        │
│  │  • 재무 정보    │  │  • 투자 의견     │  │  • 사업 구조     │        │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘        │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    데이터 처리 및 변환 (Processing & Transformation)          │
│                              [이전 '?' 단계]                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 1: 데이터 구조화 (Structured Data Extraction)                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 1.1: DART 파싱 및 섹션 추출                              │   │   │
│  │  │  • 사업의 내용, 원재료 및 생산설비 등 핵심 섹션 추출          │   │   │
│  │  │  • 임베딩 필터링으로 관련 청크만 선택                          │   │   │
│  │  │  → company_details_raw (원본 저장)                            │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 1.2: LLM 기반 구조화 (GPT-5-mini/nano)                  │   │   │
│  │  │  • biz_summary: 사업 요약 (3줄)                               │   │   │
│  │  │  • products: 주요 제품 리스트                                 │   │   │
│  │  │  • clients: 주요 고객사 리스트                                 │   │   │
│  │  │  • supply_chain: 공급망 정보 (품목-공급사 쌍)                 │   │   │
│  │  │  • risk_factors: 리스크 요인                                  │   │   │
│  │  │  • cost_structure: 비용 구조                                  │   │   │
│  │  │  • keywords: 핵심 키워드 리스트                               │   │   │
│  │  │  → company_details (구조화된 데이터 저장)                     │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            ↓                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 2: 임베딩 생성 (Embedding Generation)                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 2.1: Solar Embedding 생성 (4096차원)                     │   │   │
│  │  │  • 기업 텍스트 통합 (회사명 + 사업개요 + 제품 + 키워드)       │   │   │
│  │  │  • Solar Embedding API 호출 (배치 처리)                        │   │   │
│  │  │  • pgvector로 DB 저장 (재생성 방지)                           │   │   │
│  │  │  → company_embeddings (벡터 저장)                             │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 2.2: Anchor 임베딩 생성 (캐싱)                           │   │   │
│  │  │  • 섹터 참조 텍스트 임베딩 (1회 생성, 재사용)                 │   │   │
│  │  │  • 밸류체인 참조 텍스트 임베딩 (1회 생성, 재사용)             │   │   │
│  │  │  → 메모리 캐시 (전역 변수)                                    │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            ↓                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 3: 섹터 분류 (Sector Classification)                           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 3.1: Ensemble 섹터 분류 (4단계 앙상블)                  │   │   │
│  │  │  1. Rule-based (40%): 키워드 매칭                             │   │   │
│  │  │  2. Embedding (30%): KF-DeBERTa 후보 생성                     │   │   │
│  │  │  3. Re-ranking (20%): BGE-M3 Top-5 → Top-2                    │   │   │
│  │  │  4. GPT 검증 (10%): 최종 1~3개 섹터 결정                       │   │   │
│  │  │  → investor_sector (L1, L2, L3 태그 저장)                      │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 3.2: 계층 구조 생성 (L1 → L2 → L3)                      │   │   │
│  │  │  • L1: 대분류 (예: SEC_SEMI, SEC_FINANCE)                    │   │   │
│  │  │  • L2: 중분류 (예: MEMORY, PG)                                │   │   │
│  │  │  • L3: 소분류 태그 (예: ["반도체부품소재", "반도체장비"])     │   │   │
│  │  │  → investor_sector.sector_l1, sector_l2, sector_l3_tags        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            ↓                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 4: 밸류체인 분류 (Value Chain Classification)                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 4.1: 임베딩 기반 분류                                    │   │   │
│  │  │  • 기업 임베딩 vs Anchor 임베딩 (5단계 밸류체인)              │   │   │
│  │  │  • Cosine Similarity 계산                                     │   │   │
│  │  │  • Top-1: value_chain (예: MID_SOFT)                          │   │   │
│  │  │  • Top-2: value_chain_detail (gap < 0.1일 때만)               │   │   │
│  │  │  • Confidence: max(0.0, top1_score - top2_score)              │   │   │
│  │  │  → investor_sector.value_chain, value_chain_detail,            │   │   │
│  │  │     value_chain_confidence                                     │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            ↓                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 5: 인과 구조 분석 (Causal Structure Analysis)                   │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 5.1: 경제 변수 드라이버 추출 (GPT-5-mini)                │   │   │
│  │  │  • 섹터별 표준 드라이버 매핑 (sector_reference)               │   │   │
│  │  │  • 기업별 노출도 분석 (exposure_drivers)                       │   │   │
│  │  │  • 방향성 분석 (양/음, P/Q/C 타입)                            │   │   │
│  │  │  → causal_structure.key_drivers                                │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 5.2: Driver Tags 부여 (Backend Rule)                    │   │   │
│  │  │  • DRIVER_TAG_ALLOWLIST 기반 자동 태그 부여                  │   │   │
│  │  │  • 섹터 L2 정보 활용 (예: MEMORY → IMPORT_DEPENDENT)         │   │   │
│  │  │  • Confidence 계산 (L2 confidence 기반)                        │   │   │
│  │  │  → causal_structure.key_drivers[].driver_tags                │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 5.3: 인과 설명 생성 (GPT-5-mini)                         │   │   │
│  │  │  • 드라이버별 영향 설명 문장 생성                             │   │   │
│  │  │  • 요약 문장 생성 (summary_sentence)                         │   │   │
│  │  │  → causal_structure.summary_sentence                          │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            ↓                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Phase 6: KG Edge 구축 (Knowledge Graph Edge Creation)                │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 6.1: 공급망 관계 추출 (SUPPLIES_TO)                      │   │   │
│  │  │  • supply_chain 데이터 파싱                                   │   │   │
│  │  │  • Entity Resolution (기업명 매칭)                            │   │   │
│  │  │  → edges (source: 공급사, target: 기업)                       │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 6.2: 인과 관계 추출 (DRIVEN_BY)                          │   │   │
│  │  │  • causal_structure.key_drivers 파싱                          │   │   │
│  │  │  • Driver Tags를 properties에 포함                           │   │   │
│  │  │  • Weight 계산 (confidence 기반)                              │   │   │
│  │  │  → edges (source: 기업, target: 경제변수)                    │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                            ↓                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ Step 6.3: 분류 관계 추출 (BELONGS_TO, HAS_TAG)                │   │   │
│  │  │  • 기업 → 섹터 (BELONGS_TO)                                   │   │   │
│  │  │  • 기업 → L3 태그 (HAS_TAG)                                  │   │   │
│  │  │  • 기업 → 밸류체인 (VALUE_CHAIN_RELATED)                      │   │   │
│  │  │  → edges (다양한 관계 타입)                                   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DB 구축 (Database Construction)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ PostgreSQL + pgvector 데이터베이스 (5개 Axis 구조)                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  Axis 1: Ontology (The Brain)                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ • economic_variables: 경제 변수 (금리, 유가 등)              │   │   │
│  │  │ • sector_ontology: 섹터 온톨로지                             │   │   │
│  │  │ • sector_reference: 섹터 참조 (드라이버 매핑)                 │   │   │
│  │  │ • value_chain_reference: 밸류체인 참조                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  Axis 2: Company Master (The Body)                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ • stocks: 주식 기본 정보                                      │   │   │
│  │  │ • company_details: 구조화된 기업 정보                         │   │   │
│  │  │ • company_details_raw: 원본 데이터                            │   │   │
│  │  │ • company_embeddings: 임베딩 벡터 (pgvector)                  │   │   │
│  │  │ • investor_sector: 섹터 분류 결과                             │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  Axis 3: Qualitative Data (The Context)                             │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ • company_details: 정성 정보 (제품, 고객사, 공급망 등)      │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  Axis 4: Quantitative Data (The Numbers)                            │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ • stock_prices: 주가 데이터                                 │   │   │
│  │  │ • economic_history: 경제 변수 이력                          │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  Axis 5: Logic & Links (The KG Layer)                               │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ • edges: KG 관계 (source_id, target_id, relation_type)     │   │   │
│  │  │   - SUPPLIES_TO: 공급망 관계                                 │   │   │
│  │  │   - DRIVEN_BY: 인과 관계 (기업 → 경제변수)                   │   │   │
│  │  │   - BELONGS_TO: 섹터 소속                                    │   │   │
│  │  │   - HAS_TAG: 태그 관계                                       │   │   │
│  │  │   - VALUE_CHAIN_RELATED: 밸류체인 관계                       │   │   │
│  │  │   - properties: Driver Tags, weight, direction 등            │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    동적 밸류체인 KG (Dynamic Value Chain KG)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 실시간 반응형 지식 그래프                                            │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  🔄 경제 변수 변화 감지                                              │   │
│  │     ↓                                                                │   │
│  │  📊 영향받는 기업 자동 식별                                          │   │
│  │     • DRIVEN_BY 관계 기반                                           │   │
│  │     • Driver Tags 기반 필터링                                       │   │
│  │     ↓                                                                │   │
│  │  🔗 밸류체인 전파 분석                                               │   │
│  │     • 공급망 관계 (SUPPLIES_TO)                                     │   │
│  │     • 밸류체인 관계 (VALUE_CHAIN_RELATED)                           │   │
│  │     ↓                                                                │   │
│  │  💡 투자 인사이트 생성                                               │   │
│  │     • 섹터별 영향 분석                                               │   │
│  │     • 기업 간 연관성 분석                                            │   │
│  │     • 리스크/기회 식별                                               │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 핵심 기술 스택

### 데이터 처리
- **LLM**: GPT-5-mini/nano (구조화, 분석)
- **임베딩**: Solar Embedding (4096차원)
- **Re-ranking**: BGE-M3
- **Rule-based**: 키워드 매칭, 패턴 인식

### 데이터베이스
- **PostgreSQL 15+**: 관계형 데이터 저장
- **pgvector**: 벡터 임베딩 저장 및 검색
- **JSONB**: 구조화된 데이터 저장

### 파이프라인 최적화
- **배치 처리**: 임베딩 생성 (5-10개씩)
- **캐싱**: Anchor 임베딩 재사용
- **재시도 로직**: VPN/네트워크 오류 대응
- **병렬 처리**: 섹터 분류 (Ensemble)

## 📈 데이터 규모

- **기업 수**: 2,600개 (한국 상장사)
- **임베딩**: 2,600개 (4096차원)
- **섹터 분류**: Multi-sector 지원 (1~3개)
- **밸류체인**: 5단계 분류
- **KG Edge**: 수만 개 관계

## 🎯 핵심 차별화 포인트

1. **하이브리드 분류**: Rule + Embedding + Re-ranking + GPT
2. **계층적 섹터**: L1 → L2 → L3 태그 구조
3. **인과 구조 분석**: 경제 변수와 기업 간 인과 관계
4. **Driver Tags**: 자동 태그 부여 시스템
5. **동적 KG**: 경제 변수 변화에 실시간 반응

